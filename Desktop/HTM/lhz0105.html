<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统外落货纸 Living Spec v2.7 [版本: 660fe96]</title>
    <!-- Version: 660fe96 - 修复待提交状态审批记录显示问题 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        // 强制清除缓存并重新加载
        if (performance.navigation.type === 1) {
            // 页面刷新，清除所有缓存
            caches.keys().then(function(names) {
                for (let name of names) caches.delete(name);
            });
        }
        // 添加版本号到 window 对象，方便控制台检查
        window.APP_VERSION = '660fe96';
        console.log('✅ 页面版本:', window.APP_VERSION);
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        blue: { 50: '#eff6ff', 100: '#dbeafe', 600: '#2563EB', 700: '#1D4ED8' },
                        gray: { 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB', 400: '#9CA3AF', 500: '#6B7280' }
                    },
                    fontSize: {
                        'compact': '13px',
                        'xxs': '11px'
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: #334155; }
        
        /* Form Controls */
        .htm-input {
            height: 32px;
            font-size: 13px;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            padding: 0 8px;
            width: 100%;
            transition: all 0.2s;
            background-color: #fff;
        }
        .htm-input:focus { outline: none; border-color: #2563EB; box-shadow: 0 0 0 1px #2563EB; }
        .htm-input:disabled, .htm-input[readonly] { background-color: #F8FAFC; color: #94a3b8; cursor: not-allowed; border-color: #E2E8F0; }
        
        /* Table Styles */
        .htm-table th { background-color: #F1F5F9; color: #475569; font-weight: 600; font-size: 12px; padding: 10px 12px; text-align: left; border-bottom: 1px solid #E2E8F0; white-space: nowrap; }
        .htm-table td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #F8FAFC; color: #334155; white-space: nowrap; transition: background 0.1s; }
        .htm-table tr:hover td { background-color: #F8FAFC; }

        /* Badges */
        .badge { padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; line-height: 1.4; }
        .badge-draft { background: #DBEAFE; color: #1E40AF; border: 1px solid #BFDBFE; } 
        .badge-submitted { background: #FEF3C7; color: #92400E; border: 1px solid #FDE68A; } 
        .badge-executed { background: #D1FAE5; color: #065F46; border: 1px solid #A7F3D0; } 
        .badge-rejected { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; } 
        .badge-recalled { background: #F3F4F6; color: #4B5563; border: 1px solid #E5E7EB; } 

        .required::after { content: " *"; color: #EF4444; margin-left: 2px; }

        /* Layout */
        #ui-container { height: 95vh; display: flex; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); background: white; margin: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        
        .nav-item.active { background-color: #1d4ed8; border-left: 4px solid #60a5fa; color: white; }
        .section-title { font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 16px; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 4px; height: 16px; background-color: #2563EB; margin-right: 8px; border-radius: 2px; }
        
        input[type="checkbox"] { accent-color: #2563EB; width: 14px; height: 14px; cursor: pointer; }

        /* Modal & Utilities */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(2px); }
        .modal-content { background: white; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 500px; overflow: hidden; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .dashed-upload { border: 2px dashed #CBD5E1; border-radius: 8px; padding: 32px; text-align: center; color: #64748B; margin-top: 16px; cursor: pointer; transition: all 0.2s; background: #F8FAFC; }
        .dashed-upload:hover { border-color: #2563EB; background: #EFF6FF; color: #2563EB; }

        .container-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .group-label { font-size: 11px; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; border-bottom: 1px solid #F1F5F9; padding-bottom: 4px; }
        
        /* ULTRA HIGH VISIBILITY BOLD Scrollbar for Batch Table */
        .batch-table-container { 
            overflow-x: auto; 
            max-width: 100%; 
            padding-bottom: 0px;
            scrollbar-color: #64748B #F1F5F9; /* Firefox */
            scrollbar-width: auto; /* Firefox */
        }
        /* Webkit Scrollbar Styling (Chrome, Safari, Edge) - BOLD & THICK */
        .batch-table-container::-webkit-scrollbar {
            height: 24px; /* Very Thick */
            background-color: #F1F5F9;
            border-top: 1px solid #E2E8F0;
        }
        .batch-table-container::-webkit-scrollbar-track {
            background-color: #F1F5F9;
        }
        .batch-table-container::-webkit-scrollbar-thumb {
            background-color: #64748B; /* Dark, high contrast */
            border-radius: 6px;
            border: 5px solid #F1F5F9; /* Thick padding to make thumb pop */
        }
        .batch-table-container::-webkit-scrollbar-thumb:hover {
            background-color: #475569; /* Even darker on hover */
        }
        
        .batch-table th, .batch-table td { white-space: nowrap; }
        
        /* Custom scroll for main content */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
    </style>
    
    <!-- 在 Vue 加载之前就定义占位函数，确保始终可用 -->
    <script>
        // 立即定义占位函数，不依赖任何其他库，不使用 IIFE，直接执行
        window.showApprovalProcess = function() {
            console.warn('⚠️ showApprovalProcess 方法尚未初始化，请等待页面加载完成');
            if (window._htmApprovalProcess && typeof window._htmApprovalProcess === 'function') {
                console.log('从 _htmApprovalProcess 调用');
                return window._htmApprovalProcess();
            }
            if (window.app && typeof window.app.showApprovalProcess === 'function') {
                console.log('从 app.showApprovalProcess 调用');
                return window.app.showApprovalProcess();
            }
            alert('审批过程功能正在初始化，请稍候再试');
        };
        window._htmApprovalProcess = null;
        console.log('✅ 占位函数已定义，window.showApprovalProcess 类型:', typeof window.showApprovalProcess);
        console.log('验证 window.showApprovalProcess:', window.showApprovalProcess);
    </script>
</head>
<body>

<div id="app">
    <div id="ui-container">
        <div class="w-64 bg-slate-900 text-white flex flex-col shrink-0">
            <div class="h-14 flex items-center px-6 font-bold text-lg border-b border-slate-800 tracking-wide">
                <i class="fas fa-cube text-blue-500 mr-3"></i> HTM
            </div>
            <div class="flex-1 overflow-y-auto py-4">
                <div class="mt-2">
                    <div class="px-6 py-2 text-sm font-semibold text-slate-300 flex items-center">
                        <i class="fas fa-folder-open mr-2 text-slate-500"></i> 系统外落货纸
                    </div>
                    <div class="mt-1">
                        <div @click="switchPage('list')" :class="['nav-item px-10 py-2.5 text-compact cursor-pointer text-slate-300 flex items-center transition-colors', page === 'list' ? 'active' : 'hover:text-white']">
                            <span>系统外落货纸查询</span>
                        </div>
                        <div @click="switchPage('create')" :class="['nav-item px-10 py-2.5 text-compact cursor-pointer text-slate-300 flex items-center transition-colors', page === 'create' ? 'active' : 'hover:text-white']">
                            <span>系统外落货纸创建/编辑</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-14 border-t border-slate-800 flex items-center px-6 bg-slate-950">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs shadow-lg ring-2 ring-slate-800">W</div>
                <div class="ml-3 text-xs">
                    <div class="font-bold">Wilson (订单岗)</div>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
            <div class="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-20">
                <div class="text-compact text-slate-500">
                    HTM / 系统外落货纸 / <span class="text-slate-900 font-semibold">{{ pageTitle }}</span>
                </div>
                <div class="flex space-x-4 text-slate-400">
                    <i class="fas fa-bell hover:text-blue-600 cursor-pointer transition-colors"></i>
                </div>
            </div>

            <div v-if="page === 'list'" class="flex-1 p-6 overflow-y-auto flex flex-col custom-scroll">
                <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card mb-4 relative shrink-0">
                    <div class="grid grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">系统外落货纸号</label>
                            <input v-model="filters.id" type="text" class="htm-input" placeholder="请输入...">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">批次号</label>
                            <input v-model="filters.batch" type="text" class="htm-input" placeholder="请输入...">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">状态 (可多选)</label>
                            <select v-model="filters.status" class="htm-input text-slate-700">
                                <option value="">全部</option>
                                <option value="待提交">待提交</option>
                                <option value="提交审核">提交审核</option>
                                <option value="驳回">驳回</option>
                                <option value="执行">执行</option>
                                <option value="已撤回">已撤回</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">运输方式 (可多选)</label>
                            <select v-model="filters.transport" class="htm-input text-slate-700">
                                <option value="">全部</option>
                                <option v-for="t in transportOptions" :key="t" :value="t">{{ t }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">起运港 (POL) (可多选)</label>
                            <div class="relative">
                                <input v-model="filters.pol" type="text" class="htm-input pr-6" placeholder="如: CNTAO">
                                <i class="fas fa-chevron-down absolute right-2 top-2.5 text-slate-400 text-xxs pointer-events-none"></i>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">目的港 (POD) (可多选)</label>
                            <div class="relative">
                                <input v-model="filters.pod" type="text" class="htm-input pr-6" placeholder="如: USHOU">
                                <i class="fas fa-chevron-down absolute right-2 top-2.5 text-slate-400 text-xxs pointer-events-none"></i>
                            </div>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-500 mb-1.5">ETD (计划船期)</label>
                            <div class="relative">
                                <input v-model="filters.etdRange" type="text" class="htm-input pr-8" placeholder="YYYY-MM-DD - YYYY-MM-DD">
                                <i class="fas fa-calendar-alt absolute right-2.5 top-2 text-slate-400"></i>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-slate-500 mb-1.5">订单人员</label>
                            <input v-model="filters.person" type="text" class="htm-input" placeholder="如: Wilson">
                        </div>
                        <div class="flex items-end justify-end space-x-2">
                             <button @click="resetFilters" class="bg-white text-slate-600 text-xs px-4 h-8 rounded hover:bg-slate-50 border border-slate-300 font-medium transition-colors">
                                重置
                            </button>
                            <button @click="search" class="bg-blue-600 text-white text-xs px-6 h-8 rounded hover:bg-blue-700 font-medium shadow-sm transition-colors">
                                <i class="fas fa-search mr-1"></i> 查询
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-3 shrink-0">
                    <div class="text-sm font-bold text-slate-700 flex items-center">
                        列表 ({{ pagination.total }}) 
                        <span v-if="selectedIds.length > 0" class="text-blue-600 text-xs font-normal ml-2 bg-blue-50 px-2 py-0.5 rounded-full">
                            已选择 {{ selectedIds.length }} 项
                        </span>
                    </div>
                    <div class="space-x-2">
                         <button @click="switchPage('create')" class="bg-white border border-slate-300 text-slate-700 text-xs px-3 py-1.5 rounded hover:bg-slate-50 shadow-sm transition-colors">
                            <i class="fas fa-plus mr-1"></i> 新建
                        </button>
                        <button class="bg-white border border-slate-300 text-slate-700 text-xs px-3 py-1.5 rounded hover:bg-slate-50 shadow-sm transition-colors">
                            <i class="fas fa-file-export mr-1"></i> 导出
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg border border-slate-200 shadow-card overflow-hidden flex flex-col flex-1 relative">
                    <div class="overflow-x-auto flex-1 custom-scroll">
                        <table class="w-full htm-table">
                            <thead class="bg-slate-50 sticky top-0 z-10">
                                <tr>
                                    <th class="w-10 text-center">
                                        <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll">
                                    </th>
                                    <th>系统外落货纸号</th>
                                    <th>状态</th>
                                    <th>批次号</th>
                                    <th>运输方式</th>
                                    <th>起运港</th>
                                    <th>目的港</th>
                                    <th>箱型箱量</th>
                                    <th>最后处理时间</th>
                                    <th>订单人员</th>
                                    <th>订舱人员</th>
                                    <th>ETD <i class="fas fa-sort ml-1 cursor-pointer"></i></th>
                                    <th class="text-center w-32">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in paginatedData" :key="item.id">
                                    <td class="text-center">
                                        <input type="checkbox" :value="item.id" v-model="selectedIds">
                                    </td>
                                    <td class="font-mono text-blue-600 cursor-pointer hover:underline font-medium" @click="editOrder(item)">{{ item.id }}</td>
                                    <td><span :class="['badge', getBadgeClass(item.status)]">{{ item.status }}</span></td>
                                    <td>{{ item.batch }}</td>
                                    <td>{{ item.transport }}</td>
                                    <td>{{ item.pol }}</td>
                                    <td>{{ item.pod }}</td>
                                    <td>{{ item.container }}</td>
                                    <td class="text-slate-500 font-mono text-xs">{{ item.lastUpdate }}</td>
                                    <td>{{ item.orderPerson }}</td>
                                    <td>{{ item.bookingPerson }}</td>
                                    <td>{{ item.etd }}</td>
                                    <td class="text-center">
                                        <div class="flex justify-center items-center space-x-3">
                                            <button @click="viewOrder(item)" class="text-slate-500 hover:text-blue-600 text-xs font-medium transition-colors">查看</button>
                                            <button v-if="['待提交', '驳回'].includes(item.status)" @click="editOrder(item)" class="text-blue-600 hover:text-blue-800 text-xs font-medium transition-colors">编辑</button>
                                            <span v-else class="w-6 inline-block"></span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="h-12 border-t border-slate-200 bg-slate-50 flex justify-between items-center px-4 text-xs shrink-0">
                        <div class="text-slate-500">
                            显示第 {{ (pagination.current - 1) * pagination.size + 1 }} 到 {{ Math.min(pagination.current * pagination.size, pagination.total) }} 条
                        </div>
                        <div class="flex items-center space-x-2">
                            <span>每页显示</span>
                            <select v-model="pagination.size" @change="pagination.current = 1" class="border border-slate-300 rounded px-1 py-0.5 bg-white focus:ring-1 focus:ring-blue-500">
                                <option :value="10">10</option>
                                <option :value="20">20</option>
                                <option :value="50">50</option>
                                <option :value="100">100</option>
                            </select>
                            <div class="flex border border-slate-300 rounded bg-white shadow-sm">
                                <button @click="changePage(pagination.current - 1)" :disabled="pagination.current === 1" class="px-2 py-1 hover:bg-slate-50 disabled:opacity-50 disabled:bg-slate-50 border-r border-slate-200 transition-colors"><i class="fas fa-chevron-left"></i></button>
                                <span class="px-3 py-1 font-semibold text-slate-700">{{ pagination.current }}</span>
                                <button @click="changePage(pagination.current + 1)" :disabled="pagination.current * pagination.size >= pagination.total" class="px-2 py-1 hover:bg-slate-50 disabled:opacity-50 disabled:bg-slate-50 border-l border-slate-200 transition-colors"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="page === 'create'" class="flex-1 flex flex-col h-full bg-slate-50">
                <div class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20 sticky top-0">
                    <div class="flex items-center h-10">
                        <button @click="page='list'" class="flex items-center text-slate-500 hover:text-blue-600 transition-colors px-2">
                            <i class="fas fa-arrow-left mr-1"></i> 返回列表
                        </button>
                        
                        <div class="h-8 w-px bg-slate-200 mx-4"></div>
                        
                        <div class="flex flex-col justify-center mr-4">
                            <div class="flex items-baseline space-x-2">
                                <span class="text-xs text-slate-400">委托单号:</span>
                                <span class="font-bold text-sm text-slate-800">{{ form.id || 'LR251230001' }}</span>
                            </div>
                            <div class="mt-0.5">
                                <span v-if="form.status" :class="['badge shadow-sm', getBadgeClass(form.status)]">{{ form.status }}</span>
                            </div>
                        </div>

                        <div class="flex items-center ml-2">
                            <div v-if="showQueryInput" class="flex items-center bg-slate-100 rounded p-0.5 border border-slate-200 mr-2 transition-all">
                                <input v-model="queryIdInput" placeholder="输入系统外落货纸号..." class="bg-transparent border-0 text-xs px-2 w-48 focus:ring-0 outline-none h-7">
                            </div>
                            <button @click="toggleQuery" :class="['text-xs px-3 py-1.5 rounded transition-all border font-medium flex items-center', showQueryInput ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100']">
                                <i class="fas fa-search mr-1.5"></i> {{ showQueryInput ? '确认' : '查询单据' }}
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2 items-center" style="position: relative; z-index: 10;">
                        <template v-if="['', '待提交', '驳回', '已撤回'].includes(form.status)">
                            <button @click="handleRefCreate('header')" class="bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs hover:bg-slate-50 hover:text-blue-600 transition-colors" title="复制当前数据新建">参考创建</button>
                            <button @click="handleRefCreate('all')" class="bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs hover:bg-slate-50 hover:text-blue-600 transition-colors" title="复制头信息和批次数据">参考创建全部</button>
                            
                            <div class="h-6 w-px bg-slate-300 mx-1"></div>

                            <button @click="save" class="bg-white border border-slate-300 text-slate-700 px-3 py-1.5 rounded text-xs hover:bg-slate-50 transition-colors font-medium">保存</button>
                            <button @click="submit" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 shadow-sm transition-colors font-medium">提交审核</button>
                        </template>
                        
                        <template v-if="['待提交', '驳回', '已撤回'].includes(form.status)">
                            <button class="text-red-600 border border-red-200 bg-red-50 px-3 py-1.5 rounded text-xs hover:bg-red-100 transition-colors">删除</button>
                        </template>

                        <template v-if="['提交审核', '执行'].includes(form.status)">
                            <button @click="recall" class="bg-orange-50 border border-orange-200 text-orange-700 px-3 py-1.5 rounded text-xs hover:bg-orange-100 transition-colors">撤回</button>
                        </template>

                        <div class="h-6 w-px bg-slate-300 mx-2"></div>
                        <button type="button" @click.stop="showApprovalProcess" onclick="console.log('=== 按钮 onclick 被触发 ==='); console.log('window.showApprovalProcess:', typeof window.showApprovalProcess); console.log('window._htmApprovalProcess:', typeof window._htmApprovalProcess); console.log('window.app:', window.app); if(typeof window.showApprovalProcess === 'function') { console.log('调用 window.showApprovalProcess'); window.showApprovalProcess(); } else if(window._htmApprovalProcess && typeof window._htmApprovalProcess === 'function') { console.log('调用 window._htmApprovalProcess'); window._htmApprovalProcess(); } else if(window.app && typeof window.app.showApprovalProcess === 'function') { console.log('调用 window.app.showApprovalProcess'); window.app.showApprovalProcess(); } else { console.error('❌ showApprovalProcess 方法未找到'); alert('审批过程功能暂时不可用，请刷新页面后重试'); }" class="text-slate-500 hover:text-blue-600 text-xs ml-2 cursor-pointer" style="z-index: 1000; position: relative; pointer-events: auto; min-width: auto;"><i class="fas fa-history mr-1"></i>审批过程</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                    <div class="max-w-7xl mx-auto space-y-5">
                        
                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
                            <h3 class="section-title">基础与时间信息 (Basic & Time)</h3>
                            <div class="grid grid-cols-4 gap-5">
                                <div><label class="block text-xxs text-slate-500 mb-1.5">系统外落货纸单号</label><input v-model="form.id" readonly class="htm-input bg-slate-50"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5">最后处理时间</label><input v-model="form.lastUpdate" readonly class="htm-input bg-slate-50"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">计划船期 (ETD)</label><input type="date" v-model="form.etd" class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">计划落货日期</label><input type="date" class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5">提单日期 (Bill Date)</label><input type="date" class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5">信用证最晚装船期</label><input type="date" class="htm-input" :readonly="isReadOnly"></div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
                            <h3 class="section-title">组织人员与合同 (Organization & Contract)</h3>
                            
                            <div class="grid grid-cols-12 gap-6">
                                <div class="col-span-3 space-y-4 border-r border-slate-100 pr-4">
                                    <div class="group-label">销售信息</div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">销售组织</label><select class="htm-input" :disabled="isReadOnly"><option>CN01 海信国际营销</option></select></div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">销售部门</label><select class="htm-input" :disabled="isReadOnly"><option>D05 亚太区</option></select></div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">销售人员</label><input value="Li Ming" class="htm-input" :readonly="isReadOnly"></div>
                                </div>

                                <div class="col-span-3 space-y-4 border-r border-slate-100 pr-4">
                                    <div class="group-label">客户与条款</div>
                                    <div>
                                        <label class="block text-xxs text-slate-500 mb-1.5 required">客户名称</label>
                                        <div class="flex">
                                            <input class="htm-input rounded-r-none" placeholder="选择客户..." :readonly="isReadOnly">
                                            <button class="bg-slate-50 border border-l-0 border-slate-300 px-2.5 rounded-r hover:bg-slate-100"><i class="fas fa-search text-slate-500 text-xs"></i></button>
                                        </div>
                                    </div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">出口国家</label><select class="htm-input" :disabled="isReadOnly"><option>Australia</option></select></div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">价格条款</label><select class="htm-input" :disabled="isReadOnly"><option>FOB</option><option>CIF</option></select></div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">提单签发方式</label><select class="htm-input" :disabled="isReadOnly"><option>正本</option><option>电放</option></select></div>
                                </div>

                                <div class="col-span-3 space-y-4 border-r border-slate-100 pr-4">
                                    <div class="group-label">合同金额</div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5 required">付款条件</label><select class="htm-input" :disabled="isReadOnly"><option>T/T 30 Days</option></select></div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="block text-xxs text-slate-500 mb-1.5">凭证币种</label><select class="htm-input" :disabled="isReadOnly"><option>USD</option></select></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1.5">LC No.</label><input class="htm-input" :readonly="isReadOnly"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="block text-xxs text-slate-500 mb-1.5">LC Amount</label><input type="number" class="htm-input" :readonly="isReadOnly"></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1.5">T/T Amount</label><input type="number" class="htm-input" :readonly="isReadOnly"></div>
                                    </div>
                                    <div><label class="block text-xxs text-slate-500 mb-1.5">OA Amount</label><input type="number" class="htm-input" :readonly="isReadOnly"></div>
                                </div>

                                <div class="col-span-3 space-y-4">
                                    <div class="group-label">相关人员</div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label class="block text-xxs text-slate-500 mb-1 required">订单人员</label><input value="Wilson" class="htm-input" :readonly="isReadOnly"></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1 required">订舱人员</label><input value="Booking Agt" class="htm-input" :readonly="isReadOnly"></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1 required">单证人员</label><input value="Doc Staff" class="htm-input" :readonly="isReadOnly"></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1 required">报关人员</label><input value="Customs" class="htm-input" :readonly="isReadOnly"></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1">部门主管</label><input value="Mgr Zhang" class="htm-input" readonly></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1">财务人员</label><input value="Fin Li" class="htm-input" readonly></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1">区域经理</label><input value="Reg Mgr" class="htm-input" readonly></div>
                                        <div><label class="block text-xxs text-slate-500 mb-1">风险审批</label><input value="Risk Ctrl" class="htm-input" readonly></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
                            <h3 class="section-title">货运信息 (Logistics Flow)</h3>
                            
                            <div class="grid grid-cols-3 gap-6 mb-4">
                                <div><label class="block text-xxs text-slate-500 mb-1.5">提货地 (Place of Receipt)</label><input class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">起运港 (POL)</label><input v-model="form.pol" class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">提货地运输模式</label><select class="htm-input" :disabled="isReadOnly"><option>Truck</option></select></div>
                            </div>

                            <div class="grid grid-cols-3 gap-6 mb-4">
                                <div><label class="block text-xxs text-slate-500 mb-1.5">目的地 (Final Dest)</label><input class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">目的港 (POD)</label><input v-model="form.pod" class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">目的地运输模式</label><select class="htm-input" :disabled="isReadOnly"><option>Truck</option></select></div>
                            </div>

                            <div class="h-px bg-slate-100 my-4"></div>
                            
                            <div class="grid grid-cols-3 gap-6 mb-4">
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">运输方式</label>
                                    <select v-model="form.transport" class="htm-input" :disabled="isReadOnly">
                                        <option v-for="t in transportOptions" :key="t" :value="t">{{ t }}</option>
                                    </select>
                                </div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">生产基地</label><select class="htm-input" :disabled="isReadOnly"><option>Qingdao Factory</option></select></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">报关主体</label><select class="htm-input" :disabled="isReadOnly"><option>Hisense International</option></select></div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-6">
                                <div><label class="block text-xxs text-slate-500 mb-1.5">报关口岸</label><input class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5">多目的地描述</label><input class="htm-input" :readonly="isReadOnly"></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5">是否验货</label><select class="htm-input" :disabled="isReadOnly"><option>No</option><option>Yes</option></select></div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
                            <h3 class="section-title">箱型箱量和运保费 (Container Info & Fees)</h3>
                            <div class="flex gap-8">
                                <div class="flex-1 border-r border-slate-100 pr-8">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-xs font-bold text-slate-600">箱型明细</div>
                                        <button v-if="!isReadOnly" @click="addContainer" class="text-blue-600 text-xs hover:underline font-medium"><i class="fas fa-plus"></i> 添加</button>
                                    </div>
                                    <div class="space-y-2">
                                        <div v-for="(cont, idx) in form.containers" :key="idx" class="container-row">
                                            <div class="flex-1">
                                                <select v-model="cont.type" @change="handleContainerTypeChange(idx)" class="htm-input" :disabled="isReadOnly">
                                                    <option value="40HQ">40HQ</option>
                                                    <option value="40GP">40GP</option>
                                                    <option value="20GP">20GP</option>
                                                    <option value="LCL">LCL</option>
                                                </select>
                                            </div>
                                            <div class="w-24">
                                                <input v-model="cont.qty" type="number" class="htm-input text-center" :readonly="isReadOnly || cont.type === 'LCL'">
                                            </div>
                                            <button v-if="!isReadOnly" @click="removeContainer(idx)" class="text-slate-400 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex-1">
                                    <div class="text-xs font-bold text-slate-600 mb-2">运保费信息 <span class="text-slate-400 font-normal ml-2">(默认为空，必填可填0)</span></div>
                                    <div class="space-y-3">
                                        <div class="flex items-center gap-3">
                                            <label class="w-32 text-xs text-slate-500 text-right">费用币种</label>
                                            <select v-model="form.feeCurrency" class="htm-input flex-1" :disabled="isReadOnly">
                                                <option value="USD">USD</option>
                                                <option value="CNY">CNY</option>
                                                <option value="EUR">EUR</option>
                                                <option value="GBP">GBP</option>
                                                <option value="JPY">JPY</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-32 text-xs text-slate-500 text-right required">运费 (Freight)</label>
                                            <input type="number" class="htm-input flex-1" placeholder="0.00" :readonly="isReadOnly">
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-32 text-xs text-slate-500 text-right required">保费 (Insurance)</label>
                                            <input type="number" class="htm-input flex-1" placeholder="0.00" :readonly="isReadOnly">
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-32 text-xs text-slate-500 text-right required">其他费用 (Other)</label>
                                            <input type="number" class="htm-input flex-1" placeholder="0.00" :readonly="isReadOnly">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
                            <h3 class="section-title">收发通 (Parties)</h3>
                            <div class="grid grid-cols-3 gap-6">
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">收货人 (Consignee)</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">发货人 (Shipper)</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">通知人 (Notify)</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
                            <h3 class="section-title">备注事项 (Remarks)</h3>
                            <div class="grid grid-cols-4 gap-4">
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">船务注意事项</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">单证注意事项</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">发货注意事项</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                                <div><label class="block text-xxs text-slate-500 mb-1.5 required">物流备注 (货描)</label><textarea class="htm-input h-24 py-2 resize-none" :readonly="isReadOnly"></textarea></div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-card mb-10">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="section-title mb-0">批次明细 (Batch Details) ({{ form.products.length }}/100)</h3>
                                <div class="space-x-2">
                                    <button @click="exportBatch" class="bg-white border border-slate-300 text-slate-700 px-3 py-1.5 rounded text-xs hover:bg-slate-50 transition-colors"><i class="fas fa-file-export mr-1"></i> 导出批次</button>
                                    <template v-if="!isReadOnly">
                                        <button @click="showImportModal = true" class="text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded text-xs border border-green-700 transition-colors"><i class="fas fa-file-excel mr-1"></i> 导入批次</button>
                                        <button @click="addProduct" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 shadow-sm transition-colors"><i class="fas fa-plus mr-1"></i> 新增行</button>
                                    </template>
                                </div>
                            </div>
                            
                            <div class="batch-table-container border border-slate-200 rounded">
                                <div class="text-xs text-slate-400 p-2 bg-slate-50 border-b border-slate-100 flex items-center justify-center font-medium">
                                    <i class="fas fa-arrows-alt-h mr-2 text-slate-500"></i> <span class="text-slate-600">提示: Shift + 滚轮 或 拖动下方粗滚动条查看更多列</span>
                                </div>
                                <table class="w-full htm-table batch-table">
                                    <thead>
                                        <tr>
                                            <th class="w-10">#</th>
                                            <th>批次号</th>
                                            <th>物料编码</th>
                                            <th class="min-w-[150px]">中文名称 *</th>
                                            <th class="min-w-[150px]">英文名称</th>
                                            <th>型号</th>
                                            <th>品牌</th>
                                            <th>颜色</th>
                                            <th>配管</th>
                                            <th>数量 *</th>
                                            <th>箱数 *</th>
                                            <th>报关币种 *</th>
                                            <th>报关单价 *</th>
                                            <th>报关总价</th>
                                            <th>销售币种</th>
                                            <th>销售单价</th>
                                            <th>销售总价</th>
                                            <th>FOB币种</th>
                                            <th>单价(FOB)</th>
                                            <th>总价(FOB)</th>
                                            <th>单台净重</th>
                                            <th>单台毛重</th>
                                            <th>单台体积</th>
                                            <th>外部合同号</th>
                                            <th>产品形态 *</th>
                                            <th>总重量(Total Wt)</th>
                                            <th>总体积(Total Vol)</th>
                                            <th>贸易方式 *</th>
                                            <th class="w-16 text-center sticky right-0 bg-white shadow-[-5px_0_10px_-5px_rgba(0,0,0,0.1)]" v-if="!isReadOnly">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(p, index) in form.products" :key="index">
                                            <td class="text-center text-slate-400">{{ index + 1 }}</td>
                                            <td><input v-model="p.batch" class="htm-input border-0 bg-transparent focus:bg-white p-0 text-xs w-20" placeholder="Batch" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.code" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-20" placeholder="Code" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.name" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-32" placeholder="Name" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.enName" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-32" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.model" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-20" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.brand" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.color" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.pipe" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.qty" type="number" class="htm-input bg-blue-50 text-blue-800 font-bold text-center w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.boxes" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-center p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><select v-model="p.currency" class="htm-input border-0 bg-transparent focus:bg-white text-xs p-0 w-16" :disabled="isReadOnly"><option>USD</option></select></td>
                                            <td><input v-model="p.price" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-right p-0 w-20" :readonly="isReadOnly"></td>
                                            <td class="text-right text-slate-500 w-24">{{ (p.qty * p.price).toFixed(2) }}</td>
                                            <td><select v-model="p.salesCurrency" class="htm-input border-0 bg-transparent focus:bg-white text-xs p-0 w-16" :disabled="isReadOnly"><option>USD</option></select></td>
                                            <td><input v-model="p.salesPrice" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-right p-0 w-20" :readonly="isReadOnly"></td>
                                            <td class="text-right text-slate-500 w-24">{{ (p.qty * p.salesPrice).toFixed(2) }}</td>
                                            <td><select v-model="p.fobCurrency" class="htm-input border-0 bg-transparent focus:bg-white text-xs p-0 w-16" :disabled="isReadOnly"><option>USD</option></select></td>
                                            <td><input v-model="p.fobPrice" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-right p-0 w-20" :readonly="isReadOnly"></td>
                                            <td class="text-right text-slate-500 w-24">{{ (p.qty * p.fobPrice).toFixed(2) }}</td>
                                            <td><input v-model="p.netWeight" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-right p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.grossWeight" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-right p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.unitVol" type="number" class="htm-input border-0 bg-transparent focus:bg-white text-right p-0 w-16" :readonly="isReadOnly"></td>
                                            <td><input v-model="p.extContract" class="htm-input border-0 bg-transparent focus:bg-white p-0 w-24" :readonly="isReadOnly"></td>
                                            <td><select v-model="p.form" class="htm-input border-0 bg-transparent focus:bg-white text-xs p-0 w-20" :disabled="isReadOnly"><option>整机</option><option>散件</option></select></td>
                                            <td class="text-right text-slate-500 w-20">{{ (p.qty * p.grossWeight).toFixed(2) }}</td>
                                            <td class="text-right text-slate-500 w-20">{{ (p.qty * p.unitVol).toFixed(3) }}</td>
                                            <td><select v-model="p.tradeType" class="htm-input border-0 bg-transparent focus:bg-white text-xs p-0 w-24" :disabled="isReadOnly"><option>一般贸易</option><option>进料加工</option></select></td>
                                            <td class="text-center sticky right-0 bg-white shadow-[-5px_0_10px_-5px_rgba(0,0,0,0.1)]" v-if="!isReadOnly">
                                                <i @click="removeProduct(index)" class="fas fa-trash text-slate-300 hover:text-red-500 cursor-pointer"></i>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>

    <div v-if="showImportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="font-bold text-slate-800">批量导入批次 (Import)</h3>
                <button @click="showImportModal = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-blue-50 border border-blue-200 text-blue-800 text-xs p-3 rounded mb-4">
                    <i class="fas fa-info-circle mr-1"></i> 说明：单次最多上传 99 行数据。校验失败将无法导入。
                </div>
                <a href="#" class="text-blue-600 text-xs hover:underline"><i class="fas fa-download mr-1"></i>下载 Excel 模板</a>
                <div class="dashed-upload">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-2 text-slate-300"></i>
                    <div class="text-sm">点击上传文件 (.xlsx, .csv)</div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end space-x-2">
                <button @click="showImportModal = false" class="bg-white border border-slate-300 px-4 py-2 rounded text-sm text-slate-700 hover:bg-slate-100 transition-colors">取消</button>
                <button @click="confirmImport" class="bg-green-600 px-4 py-2 rounded text-sm text-white hover:bg-green-700 transition-colors">开始导入</button>
            </div>
        </div>
    </div>

    <div v-if="showApprovalModal" class="modal-overlay">
        <div class="modal-content" style="width: 800px; max-height: 80vh;">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="font-bold text-slate-800">审批过程查询 <span class="text-xs text-slate-400">[v660fe96]</span></h3>
                <button @click="showApprovalModal = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 120px);">
                <div v-if="approvalHistory.length === 0" class="text-center py-8 text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <div>暂无审批记录</div>
                </div>
                <table v-else class="w-full htm-table approval-table">
                    <thead>
                        <tr>
                            <th>落货纸号</th>
                            <th class="w-16">序号</th>
                            <th>审批节点名称</th>
                            <th>审批人</th>
                            <th>动作</th>
                            <th>审批意见</th>
                            <th>动作时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in approvalHistory" :key="item.id">
                            <td class="font-mono text-blue-600">{{ form.id || 'LR251230001' }}</td>
                            <td class="text-center">{{ item.sequenceNo }}</td>
                            <td>{{ item.nodeName }}</td>
                            <td>{{ item.approver || '-' }}</td>
                            <td class="text-center">
                                <span v-if="item.action === '提交审核'" class="badge badge-submitted">{{ item.action }}</span>
                                <span v-else-if="item.action === '审批通过'" class="badge badge-executed">{{ item.action }}</span>
                                <span v-else-if="item.action === '驳回'" class="badge badge-rejected">{{ item.action }}</span>
                                <span v-else-if="item.action === '转办'" class="badge badge-submitted">{{ item.action }}</span>
                                <span v-else class="text-slate-400">-</span>
                            </td>
                            <td>{{ item.comments || '-' }}</td>
                            <td class="text-slate-500 text-sm">{{ item.actionTime || '-' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end">
                <button @click="showApprovalModal = false" class="bg-green-600 px-4 py-2 rounded text-sm text-white hover:bg-green-700 transition-colors">关闭</button>
            </div>
        </div>
    </div>

</div>

<script>
    // 立即验证占位函数是否存在
    console.log('=== 主 script 开始执行 ===');
    console.log('window.showApprovalProcess 类型:', typeof window.showApprovalProcess);
    
    // 等待 Vue 加载完成
    if (typeof Vue === 'undefined') {
        console.error('❌ Vue 未加载，请检查网络连接');
    } else {
        console.log('✅ Vue 已加载');
    }
    
    const { createApp, reactive, computed, nextTick } = Vue;
    
    console.log('✅ Vue 已加载，开始初始化应用');

    const vueApp = createApp({
        setup() {
            console.log('=== Vue setup 函数开始执行 ===');
            console.log('window 对象:', typeof window);
            console.log('window._htmApprovalProcess 初始值:', window._htmApprovalProcess);
            
            const state = reactive({
                page: 'list',
                pageTitle: '查询列表',
                showImportModal: false,
                showApprovalModal: false,
                showQueryInput: false,
                queryIdInput: '',
                approvalHistory: [],
                
                transportOptions: ['By Sea', 'By Truck', 'By Rail', 'By Air', 'By Express'],

                pagination: { current: 1, size: 10, total: 0, sizes: [10, 20, 50, 100] },
                
                filters: {
                    id: '', batch: '', status: '', transport: '', pol: '', pod: '', etdRange: '', person: ''
                },
                
                selectedIds: [],

                listData: [
                    { id: 'LR251227001', batch: 'B2201', transport: 'By Sea', pol: 'CNTAO', pod: 'USHOU', container: '40HQ*2', etd: '2025-12-30', lastUpdate: '2025-12-28 10:00', orderPerson: 'Wilson', bookingPerson: 'Agent A', status: '待提交' },
                    { id: 'LR251227002', batch: 'B2205, B2206', transport: 'By Air', pol: 'CNPVG', pod: 'JPTYO', container: '', etd: '2025-12-28', lastUpdate: '2025-12-28 14:20', orderPerson: 'Li Ming', bookingPerson: 'Agent B', status: '提交审核' },
                    { id: 'LR251226088', batch: 'B2188', transport: 'By Sea', pol: 'CNTAO', pod: 'AUMEL', container: '20GP*1', etd: '2026-01-05', lastUpdate: '2025-12-26 09:00', orderPerson: 'Wilson', bookingPerson: 'Agent A', status: '执行' },
                    { id: 'LR251226099', batch: 'B2199', transport: 'By Truck', pol: 'CNQIN', pod: 'VNHAN', container: '', etd: '2025-12-25', lastUpdate: '2025-12-25 11:00', orderPerson: 'Zhang', bookingPerson: 'Agent C', status: '驳回' },
                    { id: 'LR251225001', batch: 'B2100, B2102', transport: 'By Sea', pol: 'CNSHA', pod: 'USLAX', container: '40HQ*1', etd: '2025-12-20', lastUpdate: '2025-12-20 16:30', orderPerson: 'Wilson', bookingPerson: 'Agent A', status: '已撤回' },
                    { id: 'LR251224005', batch: 'B2099', transport: 'By Rail', pol: 'CNXIY', pod: 'DEHAM', container: '40HQ*1', etd: '2025-12-18', lastUpdate: '2025-12-18 09:00', orderPerson: 'Wang', bookingPerson: 'Agent D', status: '待提交' },
                    { id: 'LR251223012', batch: 'B2088', transport: 'By Express', pol: 'CNHKG', pod: 'USNYC', container: '', etd: '2025-12-15', lastUpdate: '2025-12-15 11:00', orderPerson: 'Wilson', bookingPerson: 'Agent A', status: '提交审核' },
                ],

                form: {
                    id: '', status: '', lastUpdate: '', etd: '',
                    transport: 'By Sea', pol: '', pod: '',
                    feeCurrency: 'USD',
                    containers: [{ type: '40HQ', qty: 1 }],
                    products: []
                }
            });

            // Logic
            const paginatedData = computed(() => {
                state.pagination.total = state.listData.length;
                const start = (state.pagination.current - 1) * state.pagination.size;
                const end = start + state.pagination.size;
                return state.listData.slice(start, end);
            });

            const changePage = (page) => {
                if(page > 0 && page <= Math.ceil(state.pagination.total / state.pagination.size)) state.pagination.current = page;
            };

            const isReadOnly = computed(() => ['提交审核', '执行'].includes(state.form.status));
            const isAllSelected = computed(() => {
                const currentIds = paginatedData.value.map(item => item.id);
                return currentIds.length > 0 && currentIds.every(id => state.selectedIds.includes(id));
            });

            const toggleSelectAll = (e) => {
                const currentIds = paginatedData.value.map(item => item.id);
                if(e.target.checked) currentIds.forEach(id => !state.selectedIds.includes(id) && state.selectedIds.push(id));
                else state.selectedIds = state.selectedIds.filter(id => !currentIds.includes(id));
            };

            const addContainer = () => state.form.containers.push({ type: '40HQ', qty: 1 });
            const removeContainer = (idx) => state.form.containers.splice(idx, 1);
            const handleContainerTypeChange = (idx) => {
                if(state.form.containers[idx].type === 'LCL') {
                    state.form.containers = [{ type: 'LCL', qty: 0 }];
                }
            };

            const resetFilters = () => { state.filters = { id: '', batch: '', status: '', transport: '', pol: '', pod: '', etdRange: '', person: '' }; };
            const search = () => { state.pagination.current = 1; };
            
            const switchPage = (pageName) => {
                state.page = pageName;
                state.pageTitle = pageName === 'list' ? '查询列表' : '系统外落货纸';
                state.showQueryInput = false;
                if(pageName === 'create') {
                    state.form = { 
                        id: 'LR251230001', status: '待提交', transport: 'By Sea', 
                        feeCurrency: 'USD',
                        containers: [{ type: '40HQ', qty: 1 }],
                        products: [] 
                    };
                    // Ensure MOCK DATA IS PRESENT on create for demo
                    if(state.form.products.length === 0) editOrder({ id: 'LR251230001', status: '待提交' }); 
                }
            };

            const toggleQuery = () => {
                if(!state.showQueryInput) {
                    state.showQueryInput = true;
                } else {
                    if(!state.queryIdInput) return alert('请输入单号');
                    alert('模拟查询成功：' + state.queryIdInput);
                    state.form.id = state.queryIdInput;
                    state.showQueryInput = false;
                }
            };

            const handleRefCreate = (type) => {
                const orderId = prompt('请输入落货纸号：');
                if (orderId === null) return; // User cancelled
                if (!orderId) {
                    alert('错误：落货纸号不能为空');
                    return;
                }
                
                // Simulate checking ID
                if (orderId === 'NULL') { // Mock fail condition
                    alert('错误：无此落货纸号');
                    return;
                }

                const msg = type === 'header' 
                    ? '将覆盖当前录入的信息，你是否确认？'
                    : '将覆盖当前录入的信息及批次信息，是否确认？';

                if (confirm(msg)) {
                    alert('模拟成功：已复制数据');
                    // Mock data population logic would go here
                }
            };

            const viewOrder = (item) => { editOrder(item); };
            const editOrder = (item) => {
                state.form = JSON.parse(JSON.stringify(item));
                if(!state.form.id) state.form.id = 'LR251230001'; // Fallback
                if(!state.form.status) state.form.status = '待提交';

                // 6 High Fidelity Mock Data Rows with COMPLETE Fields
                state.form.products = [
                    { batch: 'B2201-001', code: '1001001', name: 'LED TV 55"', enName: '55 Inch UHD TV', model: '55A6G', brand: 'Hisense', color: 'Black', pipe: 'None', qty: 150, boxes: 75, currency: 'USD', price: 210.00, salesCurrency: 'USD', salesPrice: 230.00, fobCurrency: 'USD', fobPrice: 195.00, netWeight: 14.5, grossWeight: 17.2, unitVol: 0.12, extContract: 'HSA-2025-01', form: '整机', tradeType: '一般贸易' },
                    { batch: 'B2201-002', code: '1001002', name: 'Soundbar HS218', enName: '2.1CH Soundbar', model: 'HS218', brand: 'Hisense', color: 'Black', pipe: 'PVC', qty: 200, boxes: 50, currency: 'USD', price: 65.00, salesCurrency: 'USD', salesPrice: 75.00, fobCurrency: 'USD', fobPrice: 55.00, netWeight: 5.2, grossWeight: 6.8, unitVol: 0.04, extContract: 'HSA-2025-01', form: '整机', tradeType: '一般贸易' },
                    { batch: 'B2201-003', code: '2005001', name: 'Remote Control', enName: 'Smart Remote', model: 'ERF3A80', brand: 'Hisense', color: 'Silver', pipe: 'None', qty: 500, boxes: 10, currency: 'USD', price: 5.50, salesCurrency: 'USD', salesPrice: 8.00, fobCurrency: 'USD', fobPrice: 4.20, netWeight: 0.15, grossWeight: 0.20, unitVol: 0.001, extContract: 'HSA-2025-SP', form: '备件', tradeType: '进料加工' },
                    { batch: 'B2201-004', code: '3001005', name: 'User Manual', enName: 'Manual EN/ES', model: 'UM-55A6', brand: 'Hisense', color: 'White', pipe: 'None', qty: 150, boxes: 5, currency: 'USD', price: 0.50, salesCurrency: 'USD', salesPrice: 0.00, fobCurrency: 'USD', fobPrice: 0.45, netWeight: 0.05, grossWeight: 0.06, unitVol: 0.0005, extContract: 'HSA-2025-01', form: '散件', tradeType: '一般贸易' },
                    { batch: 'B2201-005', code: '4002008', name: 'Power Cable', enName: 'EU Power Cord', model: 'PC-EU-1.5', brand: 'Generic', color: 'Black', pipe: 'Rubber', qty: 150, boxes: 3, currency: 'USD', price: 1.20, salesCurrency: 'USD', salesPrice: 1.50, fobCurrency: 'USD', fobPrice: 1.00, netWeight: 0.2, grossWeight: 0.25, unitVol: 0.002, extContract: 'HSA-2025-01', form: '散件', tradeType: '进料加工' },
                    { batch: 'B2201-006', code: '5009901', name: 'Stand Base', enName: 'TV Stand Metal', model: 'SB-5501', brand: 'Hisense', color: 'Silver', pipe: 'Metal', qty: 150, boxes: 15, currency: 'USD', price: 8.00, salesCurrency: 'USD', salesPrice: 10.00, fobCurrency: 'USD', fobPrice: 7.50, netWeight: 1.2, grossWeight: 1.5, unitVol: 0.01, extContract: 'HSA-2025-01', form: '备件', tradeType: '一般贸易' }
                ];
                
                if(!state.form.containers || state.form.containers.length === 0) {
                     state.form.containers = [{ type: '40HQ', qty: 2 }];
                }

                state.page = 'create';
                state.pageTitle = '系统外落货纸';
            };

            const getBadgeClass = (status) => ({ '待提交': 'badge-draft', '提交审核': 'badge-submitted', '执行': 'badge-executed', '驳回': 'badge-rejected', '已撤回': 'badge-recalled' }[status] || 'bg-slate-100');
            const save = () => { if(!state.form.id) state.form.id = 'LR' + new Date().toISOString().slice(2,10).replace(/-/g,'') + '001'; state.form.status = '待提交'; alert('保存成功'); };
            const submit = () => { if(!state.form.pol || !state.form.pod) { alert('完整性校验失败：起运港和目的港必填 '); return; } state.form.status = '提交审核'; alert('提交成功，单据已锁定'); };
            const recall = () => { if(confirm('确定撤回吗？')) state.form.status = '已撤回'; };
            const addProduct = () => { if(state.form.products.length >= 100) return alert('最多100行'); state.form.products.push({ batch: '', qty: 0, price: 0, currency: 'USD', tradeType: '一般贸易', form: '整机' }); };
            const removeProduct = (index) => { if(state.form.products.length <= 1) { alert('不能删除最后一行 '); return; } state.form.products.splice(index, 1); };
            const confirmImport = () => { state.showImportModal = false; alert('模拟导入成功'); };
            const exportBatch = () => { if(state.form.products.length === 0) return alert('没有数据可导出'); alert('导出批次明细成功 (Mock Export)'); };

            // 生成审批历史记录
            const generateApprovalHistory = (form) => {
                const history = [];
                const currentStatus = form.status || '待提交';
                const formatTime = (time) => {
                    if (!time) return '';
                    return new Date(time).toLocaleString('zh-CN', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }).replace(/\//g, '-');
                };
                
                // 如果状态是"待提交"，不显示审批记录（因为还没有提交）
                // 修复版本: a61bab7 - 避免显示空的序号2记录
                if (currentStatus === '待提交' || !form.status) {
                    console.log('状态是待提交，返回空数组');
                    return [];
                }
                
                // 序号1：订单人员提交审核节点（所有已提交的状态都有这个节点）
                history.push({
                    id: 1,
                    sequenceNo: 1,
                    nodeName: '订单人员提交',
                    approver: form.orderPerson || 'Wilson',
                    action: '提交审核',
                    comments: form.submitComments || '', // 审批意见默认为空，只有审批人填写了才有
                    actionTime: form.submitTime || form.lastUpdate || formatTime(new Date())
                });
                
                // 序号2：区域经理审核节点（所有已提交的状态都有这个节点）
                const node2 = {
                    id: 2,
                    sequenceNo: 2,
                    nodeName: '区域经理审核',
                    approver: '',
                    action: '',
                    comments: '',
                    actionTime: ''
                };
                
                if (currentStatus === '提交审核') {
                    // 待处理状态
                    node2.approver = '-';
                    node2.action = '-';
                    node2.comments = '-';
                    node2.actionTime = '-';
                } else if (currentStatus === '执行') {
                    // 审批通过
                    node2.approver = form.regionalManager || '区域经理 张三';
                    node2.action = '审批通过';
                    node2.comments = form.approvalComments || ''; // 审批意见默认为空
                    node2.actionTime = form.approvalTime || form.lastUpdate || formatTime(new Date());
                } else if (currentStatus === '驳回') {
                    // 驳回
                    node2.approver = form.regionalManager || '区域经理 张三';
                    node2.action = '驳回';
                    node2.comments = form.rejectComments || ''; // 审批意见默认为空
                    node2.actionTime = form.rejectTime || form.lastUpdate || formatTime(new Date());
                } else if (currentStatus === '转办') {
                    // 转办
                    node2.approver = form.regionalManager || '区域经理 张三';
                    node2.action = '转办';
                    node2.comments = form.transferComments || ''; // 审批意见默认为空
                    node2.actionTime = form.transferTime || form.lastUpdate || formatTime(new Date());
                }
                
                history.push(node2);
                
                return history;
            };

            // 显示审批过程弹窗
            const showApprovalProcess = () => {
                console.log('=== showApprovalProcess 开始执行 ===');
                console.log('当前状态:', { 
                    page: state.page, 
                    formStatus: state.form.status,
                    showApprovalModal: state.showApprovalModal 
                });
                
                try {
                    const history = generateApprovalHistory(state.form);
                    console.log('生成的审批历史:', history);
                    
                    // 直接设置状态
                    state.approvalHistory = history;
                    state.showApprovalModal = true;
                    
                    console.log('状态已更新:', {
                        approvalHistory: state.approvalHistory,
                        showApprovalModal: state.showApprovalModal
                    });
                    
                    // 强制更新视图
                    nextTick(() => {
                        console.log('nextTick 执行完成, showApprovalModal:', state.showApprovalModal);
                        // 检查 DOM 中是否有弹窗元素
                        const modal = document.querySelector('.modal-overlay');
                        console.log('弹窗 DOM 元素:', modal);
                        if (!modal) {
                            console.error('弹窗元素未找到！');
                        }
                    });
                } catch (error) {
                    console.error('打开审批过程弹窗失败:', error);
                    alert('打开审批过程失败: ' + error.message);
                }
            };

            const appContext = {
                ...Vue.toRefs(state),
                paginatedData, isReadOnly, isAllSelected, toggleSelectAll, resetFilters, search, switchPage, viewOrder, editOrder, getBadgeClass, save, submit, recall, addProduct, removeProduct, confirmImport, changePage, exportBatch,
                addContainer, removeContainer, handleContainerTypeChange, toggleQuery, handleRefCreate, showApprovalProcess
            };
            
            // 在 setup 函数内部直接暴露方法到 window（使用闭包访问 state）
            // 这样不依赖 Vue 实例挂载，确保方法立即可用
            console.log('=== 准备暴露 showApprovalProcess 方法 ===');
            console.log('showApprovalProcess 函数:', typeof showApprovalProcess);
            
            const exposedMethod = showApprovalProcess;
            
            // 立即暴露到 window
            try {
                // 直接替换 window.showApprovalProcess
                window.showApprovalProcess = exposedMethod;
                // 也存储到全局变量中作为备用
                window._htmApprovalProcess = exposedMethod;
                
                // 验证是否成功
                if (window.showApprovalProcess === exposedMethod) {
                    console.log('✅ window.showApprovalProcess 已成功设置');
                } else {
                    console.error('❌ window.showApprovalProcess 设置失败');
                }
                
                window.testApprovalProcess = () => {
                    console.log('=== 手动测试审批过程 ===');
                    console.log('当前状态:', { 
                        page: state.page, 
                        formStatus: state.form.status,
                        showApprovalModal: state.showApprovalModal 
                    });
                    showApprovalProcess();
                };
                
                console.log('✅ 审批过程方法已在 setup 中暴露到 window 对象');
                console.log('window.showApprovalProcess 类型:', typeof window.showApprovalProcess);
                console.log('window._htmApprovalProcess 类型:', typeof window._htmApprovalProcess);
                console.log('验证: window.showApprovalProcess === showApprovalProcess', window.showApprovalProcess === showApprovalProcess);
            } catch (error) {
                console.error('❌ 暴露方法时出错:', error);
            }
            
            return appContext;
        }
    });
    
    // 将 Vue 实例暴露到全局
    const app = vueApp.mount('#app');
    window.app = app;
    
    // 确保方法暴露的多种方式（多重保障）
    const ensureMethodExposed = () => {
        // 方式1：检查是否已在 setup 中暴露
        if (typeof window.showApprovalProcess === 'function') {
            console.log('✅ 审批过程方法已暴露（方式1：setup 中）');
            return true;
        }
        
        // 方式1.5：从全局变量获取
        if (window._htmApprovalProcess && typeof window._htmApprovalProcess === 'function') {
            window.showApprovalProcess = window._htmApprovalProcess;
            console.log('✅ 审批过程方法已暴露（方式1.5：全局变量）');
            return true;
        }
        
        // 方式2：从 app 实例获取
        if (app && typeof app.showApprovalProcess === 'function') {
            window.showApprovalProcess = app.showApprovalProcess;
            window.testApprovalProcess = () => {
                console.log('=== 手动测试审批过程 ===');
                app.showApprovalProcess();
            };
            console.log('✅ 审批过程方法已暴露（方式2：app 实例）');
            return true;
        }
        
        return false;
    };
    
    // 立即尝试
    if (!ensureMethodExposed()) {
        // 如果立即失败，使用 nextTick 延迟尝试
        nextTick(() => {
            if (!ensureMethodExposed()) {
                // 如果还是失败，再延迟一点
                setTimeout(() => {
                    if (!ensureMethodExposed()) {
                        console.error('❌ 所有方式都失败，无法暴露 showApprovalProcess 方法');
                        console.error('app 对象:', app);
                        console.error('app.showApprovalProcess:', app?.showApprovalProcess);
                        console.error('window._htmApprovalProcess:', window._htmApprovalProcess);
                    }
                }, 100);
            }
        });
    }
</script>
</body>
</html>
